package book

import (
	"strconv"
	"fmt"

	"xiazki/internal/model"
	"xiazki/web/template/layout"
)

type Data struct {
	Book model.Book
}

templ Show(data Data) {
	@layout.Base(data.Book.Title) {
		@MainInfo(data)
		@SummaryAndTags(data)
		@Events(data)
	}
}

templ MainInfo(data Data) {
	<div class="md:flex md:items-start">
		@CoverImage(data)
		<div class="flex flex-col p-4 md:w-2/3 md:flex-row md:p-8">
			@BookDetails(data)
			@RatingSection(data)
		</div>
	</div>
}

templ CoverImage(data Data) {
	<div class="flex items-start justify-center p-4 md:w-1/3 md:p-8">
		<img
			src={ getCoverURL(data.Book.CoverURL) }
			alt={ data.Book.Title }
			class="h-80 w-52 rounded-lg object-cover shadow-md transition-shadow duration-300 hover:shadow-lg md:h-96 md:w-64"
		/>
	</div>
}

templ BookDetails(data Data) {
	<div class="flex-1">
		<div class="mb-4 flex flex-wrap items-center justify-between gap-4">
			<h1 class="wrap-break-word flex-1 text-2xl font-bold md:text-3xl">
				{ data.Book.Title }
			</h1>
		</div>
		@Authors(data)
		@BookMetadata(data)
	</div>
}

templ Authors(data Data) {
	<div class="mb-4 flex flex-row">
		<h2 class="text-foreground3 mb-2 w-24 shrink-0 text-sm font-semibold uppercase tracking-wide md:w-32">Authors:</h2>
		<div class="flex flex-wrap gap-2">
			for _, author := range data.Book.Authors {
				<a href={ "/author/" + strconv.FormatInt(author.ID, 10) }>
					<span
						class="bg-background-soft text-foreground2 hover:bg-background2 rounded-full px-3 py-1 text-sm transition-colors duration-200"
					>{ author.Name }</span>
				</a>
			}
		</div>
	</div>
}

templ BookMetadata(data Data) {
	<div class="text-card-foreground mb-4 grid grid-cols-1 gap-4">
		if data.Book.Publisher != "" {
			@BookMetadataItem("Publisher") {
				<p class="ml-4">{ data.Book.Publisher }</p>
			}
		}
		if data.Book.ISBN13 != "" || data.Book.ISBN10 != "" {
			if data.Book.ISBN13 != "" {
				@BookMetadataItem("ISBN13") {
					<p class="ml-4 font-mono">{ data.Book.ISBN13 }</p>
				}
			} else {
				@BookMetadataItem("ISBN10") {
					<p class="ml-4 font-mono">{ data.Book.ISBN10 }</p>
				}
			}
		}
		if data.Book.PageCount > 0 {
			@BookMetadataItem("Pages") {
				<p class="ml-4">{ strconv.FormatInt(data.Book.PageCount, 10) }</p>
			}
		}
		if !data.Book.PublishDate.IsZero() {
			@BookMetadataItem("Published") {
				<p class="ml-4">{ data.Book.PublishDate.Format("January 2, 2006") }</p>
			}
		}
		if data.Book.SeriesName != "" {
			@BookMetadataItem("Series") {
				<p class="ml-4">
					{ data.Book.SeriesName }
					if data.Book.SeriesNumber > 0 {
						<span class="text-foreground2 ml-2">(#{ strconv.FormatInt(int64(data.Book.SeriesNumber), 10) })</span>
					}
				</p>
			}
		}
		if data.Book.Language != "" {
			@BookMetadataItem("Language") {
				<p class="ml-4">{ data.Book.Language }</p>
			}
		}
	</div>
}

templ BookMetadataItem(name string) {
	<div class="flex flex-row">
		<h2 class="text-foreground3 mb-2 w-24 shrink-0 text-sm font-semibold uppercase tracking-wide md:w-32">{ name }:</h2>
		{ children... }
	</div>
}

templ RatingSection(data Data) {
	<div class="mt-6 md:mt-0 md:w-80 md:pl-8">
		<div class="mb-4 flex justify-end">
			@Buttons(data)
		</div>
		<div class="border-gray rounded-lg border p-6">
			<div
				id="review-section"
				class="mt-4"
				hx-get={ "/book/" + strconv.FormatInt(data.Book.ID, 10) + "/stats" }
				hx-trigger="load"
				hx-swap="innerHTML"
			>
				<div class="flex justify-center p-4">
					<div class="loader border-gray h-8 w-8 rounded-full border-4 border-t-4 ease-linear"></div>
				</div>
			</div>
		</div>
	</div>
}

templ Buttons(data Data) {
	<div class="flex shrink-0 gap-2">
		<a
			class="border-green text-green hover:bg-green hover:text-background focus:ring-green-light cursor-pointer whitespace-nowrap rounded-md border px-3 py-1 text-sm transition-colors duration-200 focus:outline-none focus:ring-2 md:px-4 md:py-2"
			href={ "/book/" + strconv.FormatInt(data.Book.ID, 10) + "/edit" }
		>
			<span class="mr-1 md:mr-2"></span>
			<span class="align-middle">Edit</span>
		</a>
		<button
			class="border-blue text-blue hover:bg-blue hover:text-background focus:ring-blue-light cursor-pointer whitespace-nowrap rounded-md border px-3 py-1 text-sm transition-colors duration-200 focus:outline-none focus:ring-2 md:px-4 md:py-2"
			hx-get={ "/book/" + strconv.FormatInt(data.Book.ID, 10) + "/add_event" }
			hx-target="#modal"
			hx-swap="innerHTML"
		>
			<span class="mr-1 md:mr-2"></span>
			<span class="align-middle">Add Event</span>
		</button>
		<button
			class="border-red text-red hover:bg-red hover:text-background focus:ring-red-light cursor-pointer whitespace-nowrap rounded-md border px-3 py-1 text-sm transition-colors duration-200 focus:outline-none focus:ring-2 md:px-4 md:py-2"
			hx-delete={ "/book/" + strconv.FormatInt(data.Book.ID, 10) }
			hx-confirm="Are you sure you want to delete this book?"
		>
			<span class="mr-1 md:mr-2">󰆴</span>
			<span class="align-middle">Delete</span>
		</button>
	</div>
}

templ OpinionsLink(bookID int64, text string) {
	<a
		class="cursor-pointer font-medium hover:underline"
		href={ "/book/" + strconv.FormatInt(bookID, 10) + "/opinions" }
	>
		{ text }
	</a>
}

templ Stats(bookID int64, stats model.ReviewStats) {
	<div class="text-center">
		<div class="mb-3">
			<div class="flex items-center justify-center gap-2">
				<span class="text-yellow text-3xl font-bold">★</span>
				<span class="text-foreground text-2xl font-bold">{ fmt.Sprintf("%.1f", stats.AverageRating) }</span>
				<span class="text-gray text-lg">/ 10</span>
			</div>
		</div>
		<div class="text-foreground3 mb-4 text-sm">
			<div class="flex items-center justify-center gap-1">
				@OpinionsLink(bookID, fmt.Sprintf("%d Opinions", stats.OpinionsCount))
				<span class="text-foreground4 mx-4">·</span>
				@OpinionsLink(bookID, fmt.Sprintf("%d Ratings", stats.RatingsCount))
			</div>
		</div>
		<div class="border-gray my-6 border-t"></div>
		<h3 class="text-foreground mb-4 text-lg font-semibold">Your Rating</h3>
		<div class="group mb-4 flex flex-row-reverse justify-center text-3xl">
			for i := 10; i >= 1; i-- {
				{{
					class := "peer cursor-pointer px-1 hover:text-yellow peer-hover:text-yellow group-hover:text-gray"
					if i <= int(stats.UserRating) {
						class += " text-yellow"
					} else {
						class += " text-gray"
					}
				}}
				<div class={ class }>
					<div
						hx-post={ "/book/" + strconv.FormatInt(bookID, 10) + "/rate" }
						hx-vals={ "{\"rating\": " + strconv.Itoa(i) + "}" }
						hx-target="#review-section"
						hx-swap="innerHTML"
					>★</div>
				</div>
			}
		</div>
	</div>
}

templ SummaryAndTags(data Data) {
	<div class="border-gray border-t p-8">
		@Summary(data)
		@Contributors(data)
		@Tags(data)
	</div>
}

templ Summary(data Data) {
	// FIXME: make the gradient apply onlt to text, not the whole box
	if data.Book.Summary == "" {
		{{ return }}
	}
	<div class="mb-6">
		<h3 class="text-gray mb-3 text-sm font-semibold uppercase tracking-wide">Summary</h3>
		<div class="relative">
			<input type="checkbox" id="summary-toggle2" class="peer/summary hidden"/>
			<div
				id="summary-box-css2"
				class="relative max-h-24 overflow-hidden pr-4 transition-all peer-checked/summary:max-h-none"
			>
				<article class="prose text-foreground1 max-w-none">{ data.Book.Summary }</article>
			</div>
			<div
				id="summary-gradient-css2"
				class="bg-linear-to-b to-background pointer-events-none absolute left-0 top-0 h-24 w-full from-transparent peer-checked/summary:hidden"
			></div>
			<label
				for="summary-toggle2"
				class="text-blue mt-2 inline cursor-pointer text-sm font-medium hover:underline peer-checked/summary:hidden"
			>Show more</label>
			<label
				for="summary-toggle2"
				class="text-blue mt-2 hidden cursor-pointer text-sm font-medium hover:underline peer-checked/summary:inline"
			>Show less</label>
		</div>
	</div>
}

templ Tags(data Data) {
	if len(data.Book.Tags) > 0 {
		<div class="mb-6">
			<h3 class="text-foreground2 mb-3 text-sm font-semibold uppercase tracking-wide">Tags</h3>
			<div class="flex flex-wrap gap-2">
				for _, tag := range data.Book.Tags {
					<span class="bg-background-soft text-foreground2 rounded-full px-3 py-1 text-sm">
						{ tag.Name }
					</span>
				}
			</div>
		</div>
	}
}

templ Contributors(data Data) {
	<div class="grid grid-cols-1 gap-6 md:grid-cols-2">
		@Translators(data)
		@Narrators(data)
	</div>
}

templ Translators(data Data) {
	if len(data.Book.Translators) > 0 {
		<div>
			<h3 class="text-foreground2 mb-2 text-sm font-semibold uppercase tracking-wide">Translators</h3>
			<ul class="space-y-1">
				for _, translator := range data.Book.Translators {
					<li class="text-foreground2">{ translator.Name }</li>
				}
			</ul>
		</div>
	}
}

templ Narrators(data Data) {
	if len(data.Book.Narrators) > 0 {
		<div>
			<h3 class="text-foreground2 mb-2 text-sm font-semibold uppercase tracking-wide">Narrators</h3>
			<ul class="space-y-1">
				for _, narrator := range data.Book.Narrators {
					<li class="text-foreground2">{ narrator.Name }</li>
				}
			</ul>
		</div>
	}
}

templ Events(data Data) {
	if len(data.Book.Events) == 0 {
		{{ return }}
	}
	<div class="border-gray border-t p-8">
		<h2 class="text-foreground1 mb-6 text-2xl font-semibold">Events</h2>
		for _, event := range data.Book.Events {
			<div class="bg-card text-card-foreground mb-4 flex items-center justify-between rounded-lg px-4 py-2">
				<div>
					switch event.Type {
						case model.EventFinished:
							<span class="text-blue font-semibold">Finished Reading </span>
						case model.EventReading:
							<span class="text-green font-semibold">Started Reading </span>
						case model.EventDropped:
							<span class="text-red font-semibold">Dropped </span>
					}
					<span class="text-foreground1 ml-2">{ event.Date.Format("January 2, 2006") }</span>
				</div>
				<div class="flex">
					<button
						hx-delete={ "/event/" + strconv.FormatInt(event.ID, 10) }
						hx-confirm="Are you sure you want to delete this event?"
						class="border-red text-red hover:bg-red hover:text-card focus:ring-red-light flex h-8 w-8 cursor-pointer items-center justify-center rounded-md border transition-colors duration-200 focus:outline-none focus:ring-2"
					>
						<span class="text-sm">󰆴</span>
					</button>
				</div>
			</div>
		}
	</div>
}

func getCoverURL(coverURL string) string {
	if coverURL != "" {
		return coverURL
	}
	return "/static/img/cover.jpeg"
}
